<script>
  $(function() {
    function loadReport () {
      let filter = new Filter()

      filter.load($('form#report-filter').serializeArray())

      return new Promise((resolve, reject) => {
        google.script.run.withSuccessHandler(content => {
          let reportList = JSON.parse(content)
          reportListElement.empty()

          console.log(reportList)

          reportList.forEach(reportRow => {
            let reportRowHtml = ejs.render(reportRowTemplate, reportRow, {delimiter: '?'});
            reportListElement.append(reportRowHtml)
          })

          $(document).trigger('search.refresh')

          resolve(content)
        }).withFailureHandler(error => {
          reject(error)
        }).getReportStringified(filter.all());
      })
    }

    function refreshReport () {
      let filter = new Filter()

      filter.load($('form#report-filter').serializeArray())

      return new Promise((resolve, reject) => {
        google.script.run.withSuccessHandler(content => {
          resolve(content)
        }).withFailureHandler(error => {
          reject(error)
        }).refreshReport(filter.all());
      })
    }
    
    loadReport()

    $('form#report-filter').on('submit', function(e) {
      e.preventDefault();

      let loader = $(this).find('[data-element="apply-button"] [data-element="loader"]')

      loader.show();

      refreshReport().then(() => {
        loadReport()
            .then(
                () => {
                  loader.hide();
                },
                error => {
                  loader.hide();
                }
            )
      })

    })


    $('form#report-filter [data-element="clear-button"]').on('click', function(e) {
      e.preventDefault();

      let loader = $(this).find('[data-element="loader"]')
      let filterForm = $('form#report-filter')

      filterForm.get(0).reset()

      loader.show();

      loadReport().then(
          () => {
            loader.hide();
          },
          error => {
            loader.hide();
          }
      )
    })


  })
</script>