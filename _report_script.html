<script>
  $(function() {
    function loadReport () {
      return new Promise((resolve, reject) => {
        google.script.run.withSuccessHandler(content => {
          let reportList = JSON.parse(content)
          reportListElement.empty()

          console.log(reportList)

          reportList.forEach(reportRow => {
            let reportRowHtml = ejs.render(reportRowTemplate, reportRow, {delimiter: '?'});
            reportListElement.append(reportRowHtml)
          })

          $(document).trigger('search.refresh')

          resolve(content)
        }).withFailureHandler(error => {
          reject(error)
        }).getReportStringified();
      })
    }

    function refreshReport () {
      let filter = new Filter()

      filter.load($('form#report-filter').serializeArray())

      return new Promise((resolve, reject) => {
        google.script.run.withSuccessHandler(content => {
          resolve(content)
        }).withFailureHandler(error => {
          reject(error)
        }).refreshReport(filter.all());
      })
    }
    
    loadReport()

    $('form#report-filter').on('submit', function(e) {
      e.preventDefault();

      if (!reportListElement.data('block')) {
        reportListElement.data('block', true)

        let loader = $(this).find('[data-element="apply-button"] [data-element="loader"]')

        loader.show();

        refreshReport().then(() => {
          loadReport()
              .then(
                  () => {
                    loader.hide();
                    reportListElement.data('block', false)
                  },
                  error => {
                    loader.hide();
                  }
              )
        })
      }

    })


    $('form#report-filter [data-element="reset-button"]').on('click', function(e) {
      e.preventDefault();

      if (reportListElement.data('block')) {
        return
      }

      let filterForm = $('form#report-filter')


      filterForm.get(0).reset()
    })


  })
</script>