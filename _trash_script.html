<script>
  $(function () {
    function loadTrash() {
      return new Promise((resolve, reject) => {
        google.script.run.withSuccessHandler(content => {
          let trashList = JSON.parse(content)
          trashListElement.empty()

          trashList.forEach(trashed => {
            let trashRowHtml = ejs.render(trashRowTemplate, trashed, {delimiter: '?'});
            trashListElement.append(trashRowHtml)
          })

          $(document).trigger('search.refresh')

          resolve(content)
        }).withFailureHandler(error => {
          reject(error)
        }).getTrashStringified();
      })
    }

    function recoverOrder(orderIndex) {
      return new Promise((resolve, reject) => {
        google.script.run.withSuccessHandler(response => {
          resolve(response)
        }).withFailureHandler(error => {
          reject(error)
        }).recoverOrder(orderIndex);
      })
    }

    loadTrash()

    $(document).on('click', 'button[data-action="trash.recover"]', function(e) {
      if (!trashListElement.data('block')) {
        trashListElement.data('block', true)


        let loader = $(this).find('[data-element="loader"]')

        let orderIndex = $(this).data('orderIndex')
        let trashRecoverModal = $('#trashRecoverModal')

        loader.show()

        recoverOrder(orderIndex)
            .then(
                () => {
                  loadTrash().then(
                      () => {
                        assemblyListTabContent.trigger('refresh')
                        shipmentListElement.trigger('refresh')
                        freeListElement.trigger('refresh')

                        loader.hide()
                        trashRecoverModal.modal('hide')

                        trashListElement.data('block', false)
                      }
                  )
                },
                error => {
                  loadTrash().then(() => {
                    messageModal.data('message', prepareError(error))
                    messageModal.modal('show')

                    assemblyListTabContent.trigger('refresh')
                    shipmentListElement.trigger('refresh')
                    freeListElement.trigger('refresh')

                    loader.hide()
                    trashRecoverModal.modal('hide')

                    trashListElement.data('block', false)
                  })
                }
            )
      }
    })

    $('#trashRecoverModal').on('show.bs.modal', function (e) {
      let button = $(e.relatedTarget)
      let orderNumber = button.data('orderNumber')
      let orderIndex = button.data('orderIndex')

      let modal = $(this)
      modal.find('[data-element="order-number"]').text(orderNumber || (orderIndex + 1))
      modal.find('[data-element="sequential-number-info"]').css('display', orderNumber ? 'none' : 'inline')

      let recoverOrderButton = modal.find('button[data-action="trash.recover"]')

      recoverOrderButton.data('orderNumber', orderNumber)
      recoverOrderButton.data('orderIndex', orderIndex)
    })

    $(document).on('trash.refresh', function() {
      loadTrash()
    })
  })
</script>