<script>
      $(function() {
        function loadFree () {
          let filter = new Filter()

          filter.load($('form#free-filter').serializeArray())

          return new Promise((resolve, reject) => {
            google.script.run.withSuccessHandler(content => {
              let freeList = JSON.parse(content)
              freeListElement.empty()

              freeList.forEach(free => {
                let freeRowHtml = ejs.render(freeRowTemplate, free, {delimiter: '?'});
                freeListElement.append(freeRowHtml)
              })

              $(document).trigger('search.refresh')

              resolve(content)
            }).withFailureHandler(error => {
              reject(error)
            }).getFreeStringified(filter.all());
          })
        }

        function updateFree(orderIndex, freeData) {
          return new Promise((resolve, reject) => {
            google.script.run.withSuccessHandler(response => {
              resolve(response)
            }).withFailureHandler(error => {
                reject(error)
            }).updateFree(orderIndex, freeData);
          })
        }

        function moveFreeToAssembly(orderIndex) {
          return new Promise((resolve, reject) => {
            google.script.run.withSuccessHandler(response => {
              resolve(response)
            }).withFailureHandler(error => {
                reject(error)
            }).moveFreeToAssembly(orderIndex);
          })
        }

        function removeFree (orderIndex) {
          return new Promise((resolve, reject) => {
            google.script.run.withSuccessHandler(() => {
              resolve()
            }).withFailureHandler(error => {
                reject(error)
            }).removeFree(orderIndex);
          })
        }

        function getorderIndex(freeElement) {
          return freeElement.data('orderIndex')
        }

        function getButtons(freeElement) {
          let setChangeModeButton = freeElement.find('button[data-action="free.set-change-mode"]')
          let saveChangesButton = freeElement.find('button[data-action="free.save-changes"]')
          let cancelChangesButton = freeElement.find('button[data-action="free.cancel-changes"]')
          let moveToAssemblyButton = freeElement.find('button[data-action="free.show-move-to-assembly-confirmation"]')
          let showRemoveConfirmationButton = freeElement.find('button[data-action="free.show-remove-confirmation"]')

          return {
            setChangeModeButton: setChangeModeButton,
            saveChangesButton: saveChangesButton,
            cancelChangesButton: cancelChangesButton,
            moveToAssemblyButton: moveToAssemblyButton,
            showRemoveConfirmationButton: showRemoveConfirmationButton
          }
        }

        loadFree()

        $('form#free-filter').on('submit', function(e) {
          e.preventDefault();

          if (!freeListElement.data('block')) {
            freeListElement.data('block', true)

            let loader = $(this).find('[data-element="apply-button"] [data-element="loader"]')

            loader.show();

            loadFree()
                .then(
                    () => {
                      loader.hide();
                      freeListElement.data('block', false)
                    },
                    error => {
                      loader.hide();
                      freeListElement.data('block', false)
                    }
                )
          }
        })


        $('form#free-filter [data-element="reset-button"]').on('click', function (e) {
          e.preventDefault();

          if (!freeListElement.data('block')) {
            freeListElement.data('block', true)

            let loader = $(this).find('[data-element="loader"]')
            let filterForm = $('form#free-filter')

            filterForm.get(0).reset()

            loader.show();

            loadFree().then(
                () => {
                  loader.hide()
                  freeListElement.data('block', false)
                },
                error => {
                  loader.hide()
                  freeListElement.data('block', false)
                }
            )
          }
        })


        $(document).on('click', 'button[data-action="free.set-change-mode"]', function(e) {
          if (freeListElement.data('block')) {
            return
          }

          let freeElements = freeListElement.find('[data-element="free"]')
          let freeElement = freeElements.has(this)

          let otherfreeElements = freeElements.filter(function() { return getorderIndex($(this)) != getorderIndex(freeElement) })


          freeElement.find('[data-name]').hide()
          freeElement.find('[name]').show()
          initFormControls(freeElement)

          let buttons = getButtons(freeElement)
          buttons.setChangeModeButton.hide()
          buttons.showRemoveConfirmationButton.hide()
          buttons.saveChangesButton.show()
          buttons.cancelChangesButton.show()

          $.each(otherfreeElements, function() {
            let freeElement = $(this);

            freeElement.find('[data-name]').show()
            freeElement.find('[name]').hide()

            let buttons = getButtons(freeElement)

            if (! buttons.setChangeModeButton.prop('disabled')) {
              buttons.setChangeModeButton.show()
            } else {
              buttons.setChangeModeButton.hide()
            }

            buttons.showRemoveConfirmationButton.show()
            buttons.saveChangesButton.hide()
            buttons.cancelChangesButton.hide()
          })
        })

        $(document).on('click', 'button[data-action="free.save-changes"]', function(e) {
          if (!freeListElement.data('block')) {
            freeListElement.data('block', true)

            let freeElement = freeListElement.find('[data-element="free"]').has(this)
            let orderIndex = getorderIndex(freeElement)

            let saveChangesButton = $(this)
            let setChangeModeButton = freeElement.find('button[data-action="free.set-change-mode"]')
            let cancelChangesButton = freeElement.find('button[data-action="free.cancel-changes"]')

            let loader = $(this).find('[data-element="loader"]')

            let form = freeElement.find('[name]')
            let freeData = getFormData(form)

            loader.show()
            updateFree(orderIndex, freeData)
            .then(
              () => {
                loadFree().then(() => {
                  loader.hide()
                  freeListElement.data('block', false)
                })
              },
              error => {
                loadFree().then(() => {
                  messageModal.data('message', prepareError(error))
                  messageModal.modal('show')

                  loader.hide()
                  freeListElement.data('block', false)
                })
              }
            )
          }
        })

        $(document).on('click', 'button[data-action="free.cancel-changes"]', function(e) {
          if (freeListElement.data('block')) {
            return
          }

          let freeElement = freeListElement.find('[data-element="free"]').has(this)
          let orderIndex = $(this).data('orderIndex')

          let buttons = getButtons(freeElement)

          freeElement.find('[data-name]').show()
          freeElement.find('[name]').hide()

          buttons.setChangeModeButton.show()
          buttons.showRemoveConfirmationButton.show()
          buttons.saveChangesButton.hide()
          buttons.cancelChangesButton.hide()
        })

        $(document).on('click', 'button[data-action="free.move-to-assembly"]', function(e) {
          if (!freeListElement.data('block')) {
            freeListElement.data('block', true)

            let orderIndex = $(this).data('orderIndex')
            let loader = $(this).find('[data-element="loader"]')
            let freeMoveToAssemblyModal = $('#freeMoveToAssemblyModal')

            loader.show()

            moveFreeToAssembly(orderIndex)
              .then(
                () => {
                  loadFree().then(() => {
                    assemblyListTabContent.trigger('refresh')
                    loader.hide()
                    freeMoveToAssemblyModal.modal('hide')
                    freeListElement.data('block', false)
                  })
                },
                error => {
                  loadFree().then(() => {
                    messageModal.data('message', prepareError(error))
                    messageModal.modal('show')

                    assemblyListTabContent.trigger('refresh')
                    loader.hide()
                    freeMoveToAssemblyModal.modal('hide')
                    freeListElement.data('block', false)
                  })
                }
              )
          }
        })

        $('#freeMoveToAssemblyModal').on('show.bs.modal', function (e) {
          var button = $(e.relatedTarget)
          var orderIndex = button.data('orderIndex')

          var modal = $(this)
          modal.find('[data-element="order-number"]').text(orderIndex)
          modal.find('button[data-action="free.move-to-assembly"]').data('orderIndex', orderIndex)
        })

        $(document).on('click', 'button[data-action="free.remove"]', function(e) {
          if (!freeListElement.data('block')) {
            freeListElement.data('block', true)

            let orderIndex = $(this).data('orderIndex')
            let loader = $(this).find('[data-element="loader"]')
            let freeRemoveModal = $('#freeRemoveModal')

            loader.show()

            removeFree(orderIndex)
              .then(response => {
                loadFree().then(response => {
                  loader.hide()
                  freeRemoveModal.modal('hide')
                  $(document).trigger('trash.refresh')
                  freeListElement.data('block', false)
                })
              })
          }
        })


        $('#freeRemoveModal').on('show.bs.modal', function (e) {
          var button = $(e.relatedTarget)
          var orderIndex = button.data('orderIndex')

          var modal = $(this)
          modal.find('[data-element="order-number"]').text(orderIndex + 1)
          modal.find('button[data-action="free.remove"]').data('orderIndex', orderIndex)
        })


        freeListElement.on('refresh', function() {
          loadFree()
        })
      })
</script>